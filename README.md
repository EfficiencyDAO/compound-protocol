Efficiency Protocol (based on Compound Protocol)
=================

The Efficiency Protocol is Efficiency DAOs lending interface, based on Compound Protocol's Contracts.

The Efficiency Protocol offers supplying or borrowing assets through the BSC network. Through the eToken contracts, accounts on the blockchain *supply* capital (Bnb or BEP-20 tokens) to receive eTokens or *borrow* assets from the protocol (holding other assets as collateral). The Efficiency eToken contracts track these balances and algorithmically set interest rates for borrowers.

Before getting started with this repo, please read about [Compound Protocol](https://github.com/compound-finance/compound-protocol/)

For questions about interacting with Efficiency, please visit [our Discord server](https://compound.finance/discord).

For security concerns, please visit [https://efficiency.finance/security](https://efficiency.finance/security) or email [security@efficiency.finance](mailto:security@efficiency.finance).

Contracts
=========

We detail a few of the core contracts in the Efficiency protocol.

<dl>
  <dt>CToken, CErc20 and CEther</dt>
  <dd>The Compound cTokens, which are self-contained borrowing and lending contracts. CToken contains the core logic and CErc20 and CEther add public interfaces for Erc20 tokens and ether, respectively. Each CToken is assigned an interest rate and risk model (see InterestRateModel and Comptroller sections), and allows accounts to *mint* (supply capital), *redeem* (withdraw capital), *borrow* and *repay a borrow*. Each CToken is an ERC-20 compliant token where balances represent ownership of the market.</dd>
</dl>

<dl>
  <dt>Comptroller</dt>
  <dd>The risk model contract, which validates permissible user actions and disallows actions if they do not fit certain risk parameters. For instance, the Comptroller enforces that each borrowing user must maintain a sufficient collateral balance across all cTokens.</dd>
  <ul>
  <em>Updating the Comptroller</em>
  <li>Follow the existing naming schema (ControllerGX)</li>
  <li>Update the scenario runner in scenario/src/Builder/ComptrollerImplBuilder.ts</li>
  <li>Create unit tests and fork simulations as necessary</li>
  <li>Call <code>npx saddle deploy Comptroller -n mainnet</code> to deploy to mainnet and generate new ABI</li>
  <ul>
    <li>The ABI can also be generated by deploying to mainnet in a fork simulation</li>
  </ul>
  <li>Call <code>node script/comptroller-abi</code> to merge the new Comptroller ABI with the Unitroller ABI</li>
  <li>Ensure that commit contains new generated Comptroller ABI</li>
  </ul>
</dl>

<dl>
  <dt>Comp</dt>
  <dd>The Compound Governance Token (COMP). Holders of this token have the ability to govern the protocol via the governor contract.</dd>
</dl>

<dl>
  <dt>Governor Alpha</dt>
  <dd>The administrator of the Compound timelock contract. Holders of Comp token may create and vote on proposals which will be queued into the Compound timelock and then have effects on Compound cToken and Comptroller contracts. This contract may be replaced in the future with a beta version.</dd>
</dl>

<dl>
  <dt>InterestRateModel</dt>
  <dd>Contracts which define interest rate models. These models algorithmically determine interest rates based on the current utilization of a given market (that is, how much of the supplied assets are liquid versus borrowed).</dd>
</dl>

<dl>
  <dt>Careful Math</dt>
  <dd>Library for safe math operations.</dd>
</dl>

<dl>
  <dt>ErrorReporter</dt>
  <dd>Library for tracking error codes and failure conditions.</dd>
</dl>

<dl>
  <dt>Exponential</dt>
  <dd>Library for handling fixed-point decimal numbers.</dd>
</dl>

<dl>
  <dt>SafeToken</dt>
  <dd>Library for safely handling Erc20 interaction.</dd>
</dl>

<dl>
  <dt>WhitePaperInterestRateModel</dt>
  <dd>Initial interest rate model, as defined in the Whitepaper. This contract accepts a base rate and slope parameter in its constructor.</dd>
</dl>

Installation
------------
To run efficiency protocol, pull the repository from GitHub and install its dependencies. You will need [yarn](https://yarnpkg.com/lang/en/docs/install/) or [npm](https://docs.npmjs.com/cli/install) installed.

    git clone https://github.com/EfficiencyDAO/compound-protocol
    cd compound-protocol
    yarn install --lock-file # or `npm install`


Testing
-------
Hardhat contract tests are defined under the [test directory](https://github.com/efficiency-finance/efficiency-protocol/tree/main/test). To run the tests run:

    yarn test


Change Logs
-------

Efficiency has forked compound protocol since commit : [a3214f67b73310d547e00fc578e8355911c9d376](https://github.com/compound-finance/compound-protocol/tree/a3214f67b73310d547e00fc578e8355911c9d376).
New features and PRs (back to compound) will be added in as necessary.

The summary of changes is as follows:

### Structure
- Include hardhat for updated deployment configuration and testing
- Include Governance/EFF.sol to deploy the EFF token
- Setup an eMarkets deployment sequence with hardhat-deploy

### Corrections / Optimization
- Remove `msg.sender == address(0)` from CToken and Comptroller
- Remove `fixBadAccruals` from Comptroller, TBD after proposal 65
- Prevent EFF token transfer to contract address
- Remove SimplePriceOracle as its unused and unsafe
- Updated SafeMath contract to a compatible version for solidity 0.8.x
- Add checks for whether contract's underlying balance stays the same before and after Sweep
- Optimize Comptroller's `liquidateCalculateSeizeTokens` function to prevent loss of precision
- Gas optimization on Comptroller by reducing boolean === true checks
- Add a check to see if collateral to be seized has entered the market
- Use timestamps instead of block number for interest rate calculation

### Additional Updates
- Include FeedPriceOracle.sol, to fetch oracle prices from Chainlink
- Include Lockdrop.sol, for EFF lockdrop token distribution
- Prevent claim unlock times greater than 2 years for Lockdrop.sol
- Optimize gas, zero out account balance before ext call for Lockdrop.sol